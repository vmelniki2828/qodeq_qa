import React, { useState, useEffect } from 'react';
import './QAAnalytics.css';

export const QAAnalytics = () => {
  const [statisticsData, setStatisticsData] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    const fetchStatistics = async () => {
      try {
        setIsLoading(true);
        setError('');

        const response = await fetch('http://185.138.164.88/api/v1/chat/statistics/?checked=true', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        setStatisticsData(data);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
        setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
      } finally {
        setIsLoading(false);
      }
    };

    fetchStatistics();
  }, []);

  if (isLoading) {
    return (
      <div className="page-content">
        <div className="qa-analytics">
          <div className="loading-container">
            <div className="loading-spinner"></div>
            <p className="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="page-content">
        <div className="qa-analytics">
          <div className="error-container">
            <div className="error-message">
              <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
              <p>{error}</p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="page-content">
      <div className="qa-analytics">
        <div className="analytics-header">
          <h1 className="analytics-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
          <p className="analytics-subtitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</p>
        </div>
        
        <div className="analytics-grid">
          {/* –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
          <div className="stats-section">
            <h2 className="section-title">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div className="stats-grid">
              <div className="stat-card">
                <div className="stat-icon">üí¨</div>
                <div className="stat-content">
                  <div className="stat-value">{statisticsData?.aggregate?.count_chats || 0}</div>
                  <div className="stat-label">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤</div>
                  <div className="stat-footer">Template</div>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">‚≠ê</div>
                <div className="stat-content">
                  <div className="stat-value">{statisticsData?.aggregate?.average_score?.toFixed(1) || 0}</div>
                  <div className="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                  <div className="stat-footer">Template</div>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">‚ö†Ô∏è</div>
                <div className="stat-content">
                  <div className="stat-value">{statisticsData?.aggregate?.count_errors || 0}</div>
                  <div className="stat-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫</div>
                  <div className="stat-footer">Template</div>
                </div>
              </div>
            </div>
          </div>

          {/* –û–ø–µ—Ä–∞—Ç–æ—Ä—ã */}
          {statisticsData?.agents && statisticsData.agents.length > 0 && (
            <div className="operators-section">
              <h2 className="section-title">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</h2>
              <div className="operators-list">
                {statisticsData.agents.map((agent, index) => (
                  <div key={agent.agents_id || index} className="operator-item">
                    <div className="operator-info">
                      <div className="operator-name">{agent.agents_name}</div>
                      <div className="operator-supervisor">{agent.head || '–ù–µ—Ç –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è'}</div>
                    </div>
                    <div className="operator-stats">
                      <div className="operator-stat">
                        <div className="operator-stat-value">{agent.total_chats || 0}</div>
                        <div className="operator-stat-label">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤</div>
                      </div>
                      <div className="operator-stat">
                        <div className="operator-stat-value">{agent.total_checked || 0}</div>
                        <div className="operator-stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                      </div>
                      <div className="operator-stat">
                        <div className="operator-stat-value">{agent.grade || 0}</div>
                        <div className="operator-stat-label">–ë–∞–ª–ª</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
