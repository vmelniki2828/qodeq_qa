import React, { useState, useEffect } from 'react';
import './QAMain.css';

export const QAMain = () => {
  const [dashboardData, setDashboardData] = useState(null);
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
    try {
      setIsLoading(true);
      setError('');

      const response = await fetch(
        'http://185.138.164.88/api/v1/profile/user/dashboard',
        {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );

      if (response.ok) {
        const data = await response.json();
        setDashboardData(data);
        console.log('–î–∞–Ω–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥–∞:', data);
      } else {
        const errorData = await response.json();
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', errorData);
        setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
      setError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="page-content">
        <div className="qa-main">
          <div className="dashboard-header">
            <h1 className="dashboard-title">–î–∞—à–±–æ—Ä–¥</h1>
            <p className="dashboard-subtitle">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
          </div>
          <div className="loading-container">
            <div className="loading-spinner"></div>
            <p className="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="page-content">
        <div className="qa-main">
          <div className="dashboard-header">
            <h1 className="dashboard-title">–î–∞—à–±–æ—Ä–¥</h1>
            <p className="dashboard-subtitle">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
          </div>
          <div className="error-container">
            <div className="error-message">
              <div className="error-icon">‚ö†Ô∏è</div>
              <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
              <p>{error}</p>
              <button onClick={fetchDashboardData} className="retry-button">
                –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="page-content">
      <div className="qa-main">
        <div className="dashboard-header">
          <h1 className="dashboard-title">–î–∞—à–±–æ—Ä–¥</h1>
          <p className="dashboard-subtitle">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
          <button className="create-button">
            <span className="create-icon">+</span>
            Create
          </button>
        </div>

        {dashboardData && (
          <div className="dashboard-grid">
            {/* –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */}
            {dashboardData.analytics && (
              <div className="stats-section">
                <h2 className="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div className="stats-grid">
                  <div className="stat-card">
                    <div className="stat-icon">üí¨</div>
                    <div className="stat-content">
                      <div className="stat-value">{dashboardData.analytics.total_chats}</div>
                      <div className="stat-label">–í—Å–µ–≥–æ —á–∞—Ç–æ–≤</div>
                      <div className="stat-footer">Template</div>
                    </div>
                  </div>
                  <div className="stat-card">
                    <div className="stat-icon">‚≠ê</div>
                    <div className="stat-content">
                      <div className="stat-value">{dashboardData.analytics.average_rating}%</div>
                      <div className="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
                      <div className="stat-footer">Template</div>
                    </div>
                  </div>
                  <div className="stat-card">
                    <div className="stat-icon">ü§ñ</div>
                    <div className="stat-content">
                      <div className="stat-value">{dashboardData.analytics.active_agents}</div>
                      <div className="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã</div>
                      <div className="stat-footer">Template</div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ */}
            {dashboardData.integrations && (
              <div className="integrations-section">
                <h2 className="section-title">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h2>
                <div className="integrations-list">
                  {dashboardData.integrations.map((integration, index) => (
                    <div key={index} className="integration-item">
                      <div className="integration-status">
                        <div className={`status-dot ${integration.status}`}></div>
                        <span className="status-text">
                          {integration.status === 'enabled' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–û—Ç–∫–ª—é—á–µ–Ω–∞'}
                        </span>
                      </div>
                      <div className="integration-name">{integration.name}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è */}
            {dashboardData.errors && dashboardData.errors.length > 0 && (
              <div className="warnings-section">
                <h2 className="section-title">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h2>
                <div className="warnings-list">
                  {dashboardData.errors.map((error, index) => (
                    <div key={index} className="warning-item">
                      <div className="warning-icon">‚ö†Ô∏è</div>
                      <div className="warning-content">
                        <div className="warning-message">{error.message}</div>
                        <div className="warning-meta">
                          <span className="warning-type">{error.type}</span>
                          <span className="warning-time">
                            {new Date(error.timestamp).toLocaleString('ru-RU')}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};
